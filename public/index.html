<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass 2</title>
    <!-- <link rel="stylesheet" href="./ofStyles.css"> -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1e1e2e;
            color: #dcdcdc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .outbox {
            border-top: #dcdcdc 2px solid;
            border-bottom: #dcdcdc 2px solid;
            display: flex;
            align-items: center;
            width: 90vw;
            padding: 0% 5% 2% 5%;
            position: relative;
        }

        /* .outbox::after {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    left: 40%;
    width: 2px;
    background-color: #dcdcdc;
} */

        .left,
        .right {
            margin-left: 20px;
            display: flex;
            justify-content: center;
            flex-direction: column;
        }

        .left {
            width: 44%;
        }

        .right {
            width: 56%;
        }

        .left-box,
        .right-box {
            background-color: #282a36;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 90%;
        }

        h1 {
            color: #6bff90;
            text-align: center;
            margin: 3% 0% 2% 0%;
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(45deg, #6bff90, #30ffcb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1);
            letter-spacing: 3px;
        }

        p {
            color: #bd93f9;
            text-align: center;
            margin: 0;
            font-size: 24px;
        }

        textarea {
            width: 100%;
            height: 270px;
            background-color: #44475a;
            color: #f8f8f2;
            border: none;
            border-radius: 5px;
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            box-sizing: border-box;
            resize: none;
            font-family: "Courier New", Courier, monospace;
        }

        button {
            background-color: #44475a;
            color: #f8f8f2;
            border: none;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }

        button:hover {
            background-color: #495477;
        }

        .edit-btn {
            margin-top: 40px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .pen-btn,
        .download,
        .upload {
            margin-left: 5px;
            border: rgb(70, 70, 82) 1px solid;
            padding: 4px;
            background-color: #313443;
            border-radius: 3px;
            cursor: pointer;
        }

        .download {
            padding: 6px;
            margin-left: 10px;
        }

        .upload {
            padding: 6px;
            rotate: 180deg;
        }

        .saver {
            display: flex;
            align-items: center;
        }

        .save-btn {
            margin-left: 5px;
            background-color: #23863c;
        }

        .save-btn:hover {
            background-color: #1a6f2d;
        }

        .reset-btn {
            margin-left: 5px;
            background-color: #a25d44;
        }

        .reset-btn:hover {
            background-color: #804935;
        }

        .run-btn {
            margin-left: 5px;
            background-color: #a25d44;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }

        .run-btn:hover {
            background-color: #804935;
        }
    </style>
</head>

<body>

    <div class="headout">
        <div class="head">
            <h1>Pass 2 Assembler</h1>
        </div>
    </div>
    <div class="outbox">
        <div class="left">
            <h2>Input</h2>
            <div class="left-box">
                <button class="input-btn">Input</button>
                <button class="optab-btn">Optab</button>

                <!-- <h1>Work on Something</h1> -->
                <!-- <p>Start typing below:</p> -->

                <div class="edit-btn">
                    <p id="lname"></p>
                    <div class="saver">

                        <button class="pen-btn" id="editButton">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                                data-view-component="true" class="octicon octicon-pencil" fill="#dddddd">
                                <path
                                    d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z">
                                </path>
                            </svg>
                        </button>
                        <!-- <button class="upload">
                            <svg aria-hidden="true" focusable="false" role="img" class="octicon octicon-download"
                                viewBox="0 0 16 16" width="16" height="16" fill="#dddddd"
                                style="display: inline-block; user-select: none; vertical-align: text-bottom; overflow: visible;">
                                <path
                                    d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z">
                                </path>
                                <path
                                    d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z">
                                </path>
                            </svg>
                        </button> -->
                        <button class="save-btn leftsave">Save</button>
                        <button class="left-download download">
                            <svg aria-hidden="true" focusable="false" role="img" class="octicon octicon-download"
                                viewBox="0 0 16 16" width="16" height="16" fill="#dddddd"
                                style="display: inline-block; user-select: none; vertical-align: text-bottom; overflow: visible;">
                                <path
                                    d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z">
                                </path>
                                <path
                                    d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>


                <textarea readonly></textarea>
            </div>
        </div>

        <div class="center">
            <button class="run-btn">Run</button>
        </div>

        <div class="right">
            <h2>Output</h2>
            <div class="right-box">
                <button class="intermediate-btn">Intermediate File</button>
                <button class="symtab-btn">Symtab</button>
                <button class="output-btn">Output</button>

                <div class="edit-btn">
                    <p id="rname"></p>
                    <div class="saver">
                        <!-- <a href="" class="pen-btn" id="editButton" title="Click to edit">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                                data-view-component="true" class="octicon octicon-pencil">
                                <path
                                    d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z">
                                </path>
                            </svg>
                        </a> -->
                        <button class="reset-btn">Reset</button>
                        <button class="right-download download">
                            <svg aria-hidden="true" focusable="false" role="img" class="octicon octicon-download"
                                viewBox="0 0 16 16" width="16" height="16" fill="currentColor"
                                style="display: inline-block; user-select: none; vertical-align: text-bottom; overflow: visible;">
                                <path
                                    d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z">
                                </path>
                                <path
                                    d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
                <textarea readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        let leftselected, rightselected, side

        document.addEventListener('DOMContentLoaded', async () => {
            leftselected = "input"
            rightselected = "intermediate"
            document.querySelector('.input-btn').click()
            document.querySelector('.intermediate-btn').click()
        })

        document.querySelector('.left-box textarea').addEventListener('blur', function () {
            this.setAttribute('readonly', true)
            document.querySelector('.leftsave').click()
        })

        document.querySelector('.input-btn').addEventListener('click', async () => {
            if (document.querySelector('.left-box textarea').value !== localStorage.getItem('optab.txt') && leftselected === "optab" && localStorage.getItem('optab.txt')) {
                const result = confirm('You have unsaved changes. Do you want to save them?')
                if (result) {
                    document.querySelector('.leftsave').click()
                } else {
                    return
                }
            }

            document.querySelector('#lname').textContent = "Input File"
            leftselected = "input"
            document.querySelector('.input-btn').style.backgroundColor = "#38405c"
            document.querySelector('.optab-btn').style.backgroundColor = "#44475a"

            const text = localStorage.getItem('input.txt')
            if (text) {
                document.querySelector('.left-box textarea').value = text
            } else {
                document.querySelector('.left-box textarea').value = ""
                document.querySelector('.left-box textarea').placeholder = "Write your input code here"
            }
        })
        document.querySelector('.optab-btn').addEventListener('click', async () => {
            if (document.querySelector('.left-box textarea').value !== localStorage.getItem('input.txt') && leftselected === "input" && localStorage.getItem('input.txt')) {
                const result = confirm('You have unsaved changes. Do you want to save them?')
                if (result) {
                    document.querySelector('.leftsave').click()
                } else {
                    return
                }
            }

            document.querySelector('#lname').innerHTML = "Optab File"
            leftselected = "optab"
            document.querySelector('.optab-btn').style.backgroundColor = "#38405c"
            document.querySelector('.input-btn').style.backgroundColor = "#44475a"

            const text = localStorage.getItem('optab.txt')
            if (text) {
                document.querySelector('.left-box textarea').value = text
            } else {
                document.querySelector('.left-box textarea').value = ""
                console.log('No optab file found in local storage')
                document.querySelector('.left-box textarea').placeholder = "Write your optab code here"
            }
        })

        document.querySelector('.intermediate-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Intermediate File"
            rightselected = "intermediate"
            document.querySelector('.intermediate-btn').style.backgroundColor = "#38405c"
            document.querySelectorAll('.symtab-btn, .output-btn').forEach((btn) => {
                btn.style.backgroundColor = "#44475a"
            })

            const text = localStorage.getItem('intermediate.txt')
            if (text) {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
                document.querySelector('.right-box textarea').placeholder = "Run the assembler to generate intermediate file"
            }
        })
        document.querySelector('.symtab-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Symtab File"
            rightselected = "symtab"
            document.querySelector('.symtab-btn').style.backgroundColor = "#38405c"
            document.querySelectorAll('.intermediate-btn, .output-btn').forEach((btn) => {
                btn.style.backgroundColor = "#44475a"
            })

            const text = localStorage.getItem('symtab.txt')
            if (text) {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
                document.querySelector('.right-box textarea').placeholder = "Run the assembler to generate symtab file"
            }
        })
        document.querySelector('.output-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Output File"
            rightselected = "output"
            document.querySelector('.output-btn').style.backgroundColor = "#38405c"
            document.querySelectorAll('.symtab-btn, .intermediate-btn').forEach((btn) => {
                btn.style.backgroundColor = "#44475a"
            })

            const text = localStorage.getItem('output.txt')
            if (text && text !== "AUGEYSTOOOO") {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
                document.querySelector('.right-box textarea').placeholder = "Run the assembler to generate output file"
            }
        })

        document.getElementById('editButton').addEventListener('click', function () {
            const textarea = document.querySelector('.left-box textarea')
            textarea.removeAttribute('readonly')
            textarea.focus()
        })

        document.querySelector('.leftsave').addEventListener('click', async function () {
            console.log('leftsave clicked')
            const textArea = document.querySelector('.left-box textarea')
            const content = textArea.value

            let fileName
            if (leftselected === "input") {
                fileName = 'input.txt'
            } else if (leftselected === "optab") {
                fileName = 'optab.txt'
            }

            localStorage.setItem(fileName, content)
        })

        document.querySelector('.left-download').addEventListener('click', async function () {
            side = "left"
        })
        document.querySelector('.right-download').addEventListener('click', async function () {
            side = "right"
        })
        document.querySelectorAll('.download').forEach(element => {
            element.addEventListener('click', async function () {
                let fileName
                if (side === "left") {
                    leftselected === "input" ? fileName = 'input.txt' : fileName = 'optab.txt'
                } else if (side === "right") {
                    if (rightselected === "intermediate") {
                        fileName = 'intermediate.txt'
                    } else if (rightselected === "symtab") {
                        fileName = 'symtab.txt'
                    } else if (rightselected === "output") {
                        fileName = 'output.txt'
                    }
                }
                const text = localStorage.getItem(fileName)


                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] },
                        }],
                    })

                    const writable = await handle.createWritable()
                    await writable.write(text)
                    await writable.close()
                } catch (error) {
                    console.error('Error saving file:', error)
                }
            })
        })

        document.querySelector('.reset-btn').addEventListener('click', async () => {
            const result = confirm('Do you want to clear both the files?')
            if (result) {
                document.querySelector('.left-box textarea').value = ""
                document.querySelector('.right-box textarea').value = ""
                localStorage.clear()

                document.querySelector('.left-box textarea').placeholder = "Write your " + leftselected + " code here"
                document.querySelector('.right-box textarea').placeholder = "Run the assembler to generate " + rightselected + " file"
            }
        })

        document.querySelector('.run-btn').addEventListener('click', async () => {
            const inputString = localStorage.getItem('input.txt')
            const optabString = localStorage.getItem('optab.txt')

            try {
                const response = await fetch("/pass1", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: inputString,
                        optab: optabString
                    })
                })

                if (response.ok) {
                    const text = await response.json()
                    localStorage.setItem('intermediate.txt', text.intermediate)
                    localStorage.setItem('symtab.txt', text.symtab)
                    localStorage.setItem('output.txt', text.output)

                    if (rightselected === "intermediate")
                        document.querySelector('.right-box textarea').value = text.intermediate
                    else if (rightselected === "symtab")
                        document.querySelector('.right-box textarea').value = text.symtab
                    else if (rightselected === "output" && text.output !== "AUGEYSTOOOO")
                        document.querySelector('.right-box textarea').value = text.output
                } else {
                    if (response.status === 400) {
                        alert("Input or Optab file missing")
                    } else if (response.status === 505) {
                        const text = await response.json()
                        localStorage.setItem('intermediate.txt', text.intermediate)
                        localStorage.setItem('symtab.txt', text.symtab)
                        localStorage.setItem('output.txt', text.output)
                        if (rightselected === "intermediate") {
                            document.querySelector('.right-box textarea').value = text.intermediate
                        } else if (rightselected === "symtab") {
                            document.querySelector('.right-box textarea').value = text.symtab
                        } else if (rightselected === "output") {
                            document.querySelector('.right-box textarea').value = ""
                            document.querySelector('.right-box textarea').placeholder = "Wrong input or optab."
                        }
                    } else {
                        console.log("Couln't fetch pass 1.")
                    }
                }
            } catch (err) {
                console.log(err)
            }
        })
    </script>
    <!-- <script src="./passhandling.js"></script> -->
</body>

</html>